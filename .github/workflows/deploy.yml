name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.VPS_SSH_KEY }}
          known_hosts: unnecessary
          if_key_exists: replace

      - name: Add VPS to known hosts
        run: ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e

            echo "ğŸš€ Starting deployment..."

            cd /home/core/apps/core

            # Initialize rbenv (add shims to PATH for bundle/rails commands)
            export PATH="/home/core/.rbenv/shims:/home/core/.rbenv/bin:$PATH"
            eval "$(/home/core/.rbenv/bin/rbenv init - bash)"

            # Pull latest changes
            echo "ğŸ“¥ Pulling latest code from main..."
            git fetch origin
            git reset --hard origin/main

            # Generate REVISION file with commit SHA, branch, and commit count
            echo "ğŸ“ Generating REVISION file..."
            COMMIT_SHA=$(git rev-parse HEAD)
            BRANCH=$(git rev-parse --abbrev-ref HEAD)
            COMMIT_COUNT=$(git rev-list --count HEAD)
            echo "${COMMIT_SHA}|${BRANCH}|${COMMIT_COUNT}" > REVISION
            echo "âœ… REVISION: ${BRANCH}@${COMMIT_SHA:0:7} (${COMMIT_COUNT} commits)"

            # Install dependencies
            echo "ğŸ“¦ Installing dependencies..."
            bundle install --deployment --without development test

            # Load environment variables
            export $(cat .env | grep -v '^#' | xargs)

            # Precompile assets
            echo "ğŸ¨ Precompiling assets..."
            RAILS_ENV=production bundle exec rails assets:precompile

            # Run database migrations
            echo "ğŸ—„ï¸  Running database migrations..."
            RAILS_ENV=production bundle exec rails db:migrate

            # Restart services (zero-downtime)
            echo "ğŸ”„ Restarting Puma (zero-downtime)..."
            sudo systemctl reload core-puma

            echo "ğŸ”„ Restarting Solid Queue..."
            sudo systemctl restart core-solidqueue

            # Verify deployment
            echo "âœ… Deployment complete!"
            echo "ğŸ“Š App status:"
            sudo systemctl status core-puma --no-pager -l

          ENDSSH

      - name: Verify deployment
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          # Wait for app to be ready
          sleep 5

          # Check if site is responding
          if curl -f -s -o /dev/null https://rectorspace.com/up; then
            echo "âœ… Production site is healthy!"
          else
            echo "âŒ Production site health check failed!"
            exit 1
          fi

      - name: Notify deployment success
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "ğŸŒ Visit: https://rectorspace.com"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Check logs: https://github.com/${{ github.repository }}/actions"
