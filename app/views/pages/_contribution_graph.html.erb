<%= turbo_frame_tag "contribution-graph" do %>
  <% if contributions && contributions[:weeks].any? %>
    <%
      # Find busiest day
      all_days = contributions[:weeks].flatten
      busiest_day = all_days.max_by { |d| d[:count] }

      # Get ordered list of months that appear in the data
      months_in_order = []
      contributions[:weeks].each do |week|
        first_day = week.first
        if first_day
          date = Date.parse(first_day[:date])
          month_key = date.strftime("%b")
          months_in_order << month_key unless months_in_order.last == month_key
        end
      end

      # Determine label for total
      year_label = selected_year == "last" ? "in the last year" : "in #{selected_year}"
    %>

    <div class="contribution-container">
      <!-- Year Selector Tabs -->
      <div class="year-tabs">
        <% available_years.first(5).each do |year_data| %>
          <% year = year_data[:year].to_s %>
          <%= link_to year,
              root_path(year: year),
              class: "year-tab #{selected_year == year ? 'year-tab-active' : ''}",
              data: { turbo_frame: "contribution-graph" } %>
        <% end %>
      </div>

      <!-- Streak Badge -->
      <div class="streak-badge">
        <% has_previous = false %>
        <% if contributions[:current_streak].to_i > 0 %>
          <span class="streak-fire">ðŸ”¥</span>
          <span class="streak-current"><%= contributions[:current_streak] %>-day streak</span>
          <% has_previous = true %>
        <% end %>
        <% if contributions[:longest_streak].to_i > 0 %>
          <% if has_previous %><span class="streak-separator">â€¢</span><% end %>
          <span class="streak-longest">Longest: <%= contributions[:longest_streak] %> days</span>
          <% has_previous = true %>
        <% end %>
        <% if busiest_day && busiest_day[:count].to_i > 0 %>
          <% if has_previous %><span class="streak-separator">â€¢</span><% end %>
          <span class="streak-best">Best: <%= busiest_day[:count] %> on <%= Date.parse(busiest_day[:date]).strftime("%b %-d") %></span>
        <% end %>
      </div>

      <!-- Month Labels -->
      <div class="contribution-months">
        <% months_in_order.each do |month| %>
          <span class="month-label"><%= month %></span>
        <% end %>
      </div>

      <!-- Contribution Grid -->
      <div class="contribution-graph">
        <div class="contribution-grid">
          <% week_num = 0 %>
          <% contributions[:weeks].each do |week| %>
            <% week.each_with_index do |day, day_index| %>
              <% is_busiest = busiest_day && day[:date] == busiest_day[:date] && day[:count] == busiest_day[:count] %>
              <div class="contribution-day contribution-level-<%= day[:level] %><%= ' busiest-day' if is_busiest %>"
                   data-date="<%= Date.parse(day[:date]).strftime("%b %-d, %Y") %>"
                   data-count="<%= day[:count] %>"
                   style="animation-delay: <%= week_num * 15 %>ms"></div>
            <% end %>
            <% (7 - week.size).times do %>
              <div class="contribution-day contribution-level-0" style="animation-delay: <%= week_num * 15 %>ms"></div>
            <% end %>
            <% week_num += 1 %>
          <% end %>
        </div>
      </div>

      <!-- Stats Footer -->
      <div class="contribution-stats">
        <span class="contribution-total">
          <span class="contribution-total-number"><%= number_with_delimiter(contributions[:total]) %></span>
          contributions <%= year_label %>
        </span>
        <div class="contribution-legend">
          <span>Less</span>
          <div class="contribution-legend-box contribution-level-0"></div>
          <div class="contribution-legend-box contribution-level-1"></div>
          <div class="contribution-legend-box contribution-level-2"></div>
          <div class="contribution-legend-box contribution-level-3"></div>
          <div class="contribution-legend-box contribution-level-4"></div>
          <span>More</span>
        </div>
      </div>
    </div>
  <% end %>
<% end %>
